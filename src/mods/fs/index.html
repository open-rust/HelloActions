<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>File browser</title>
    <script>
    </script>

    <style>
        html {
            width: 100%;
            height: 100%;
        }

        body,
        div {
            margin: 0px;
            padding: 0px;
        }

        .title {
            background: darkcyan;
            color: #0ff;
            padding: 15px 20px;
            font-family: 'Courier New', monospace;
            font-size: 1.7rem;
            font-weight: bold;
            text-shadow: 0 0 8px #0ff;
            border: 1px solid #0ff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .list {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: black;
            padding: 15px 25px;
            font-size: 1.6rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .list {
            /* background-color: pink; */
            padding: 6px;
        }

        a {
            text-decoration: none;
        }

        a.dir::before {
            content: "üìÅ ";
            margin-right: 5px;
        }

        a.dir {
            color: darkred;
        }

        a.file::before {
            content: "üìÑ ";
            margin-right: 5px;
        }

        a.file {
            color: green;
        }
    </style>
</head>
<div class="title">
    <span>Êñá‰ª∂ÊµèËßàÂô®: </span><span id="pwd"></span>
</div>
<div class="list">
    <table id="ls">
    </table>
</div>
<script>
    function handleName(str) {
        const tmp = decodeURIComponent(str).replace(/</g, "&lt;").replace(/>/g, "&gt;")
        // console.log(`ÊõøÊç¢${str} -> ${tmp}`)
        return tmp
    }

    function updateList(target) {
        const r = JSON.parse(target.responseText)
        const pwd = decodeURIComponent(r.pwd)

        let parent = ""
        const mr = pwd.match(/(.*)\//)
        if (mr != null) { parent = mr[1] } else { parent = "/" }

        // console.log(`pwd -> ${pwd}`)
        // console.log(`parent -> ${parent}`)

        const spanPwd = document.querySelector("span#pwd")
        spanPwd.innerText = decodeURIComponent(handleName(pwd))
        const tableLs = document.querySelector("table#ls")
        tableLs.innerHTML = `<tr><td><a href="javascript: ls('${decodeURI(parent)}')">ËøîÂõû‰∏ä‰∏ÄÁ∫ßÁõÆÂΩï</a></td></tr>`;
        for (let i = 0; i < r.dirs.length; i++) {
            tableLs.innerHTML += `<tr><td><a class="dir" href="javascript: ls('${r.pwd}/${r.dirs[i]}')">${handleName(r.dirs[i])}</a></td></tr>`;
        }
        for (let i = 0; i < r.files.length; i++) {
            var _href = './' + r.pwd + '/' + r.files[i];
            _href = _href.replace('//', '/');
            tableLs.innerHTML += `<tr><td><a class="file" target="_blank" href="${_href}">${handleName(r.files[i])}</a></td></tr>`;
        }
    }

    function ls(path) {
        var xhr = new XMLHttpRequest();
        console.log(`${xhr.readyState} -> UNSET ÂØπË±°ÂàõÂª∫ÂÆåÊàê`);
        xhr.open(method = "GET", url = `/ls?${path}`);
        xhr.timeout = 2000
        xhr.ontimeout = event => {
            console.log("timeout")
            alert("Âä†ËΩΩÂ§±Ë¥•ÔºÅ")
        }
        console.log(`${xhr.readyState} -> OPENED Â∑≤ËÆæÁΩÆopenÁõÆÊ†á`);
        xhr.addEventListener(
            "readystatechange", event => {
                switch (event.target.readyState) {
                    case 2:
                        console.log(`${xhr.readyState} -> HEADERS_RECEIVED Â∑≤Ë∞ÉÁî®sendÊñπÊ≥ï`);
                        break;
                    case 3:
                        console.log(`${xhr.readyState} -> LOADING Êé•Êî∂response‰∏≠`);
                        break;
                    case 4:
                        console.log(`${xhr.readyState} -> DONE responseÊé•Êî∂ÂÆåÊØï`);
                        updateList(event.target);
                        break;
                    default:
                        console.log("Unknown state");
                }
            }
        )
        xhr.send();
    }

    ls("");
</script>

</html>